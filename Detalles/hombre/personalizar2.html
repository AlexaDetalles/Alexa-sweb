<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ALEXA | Luxury Personalization</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;0,900;1,400&family=Plus+Jakarta+Sans:wght@200;300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --bg-void: #050203; 
            --accent-blue: #2563eb; 
            --primary-blue: #1e3a8a;
            --light-blue: #60a5fa; 
            --text-main: #f8fafc; 
            --glass-surface: rgba(255, 255, 255, 0.03);
            --glass-border: rgba(255, 255, 255, 0.1);
            --font-serif: 'Playfair Display', serif;
            --font-sans: 'Plus Jakarta Sans', sans-serif;
            --card-radius: 24px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            background-color: var(--bg-void); 
            color: var(--text-main); 
            font-family: var(--font-sans); 
            overflow-x: hidden; 
            min-height: 100vh;
            transition: opacity 0.5s ease;
        }

        /* --- BACKGROUND FX --- */
        #particleCanvas { position: fixed; inset: 0; z-index: -1; pointer-events: none; }
        .ambient-light {
            position: fixed; top: -10%; left: 50%; transform: translateX(-50%);
            width: 140vw; height: 100vh;
            background: radial-gradient(circle, rgba(37, 99, 235, 0.08) 0%, transparent 70%);
            z-index: -2; pointer-events: none; filter: blur(100px);
        }

        @keyframes breathe {
            from { opacity: 0.4; transform: translateX(-50%) scale(1); }
            to { opacity: 0.7; transform: translateX(-50%) scale(1.1); }
        }

        /* --- LOADER --- */
        #luxury-loader {
            position: fixed; inset: 0; background: var(--bg-deep);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 1000000; transition: all 1s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .loader-ring {
            width: 100px; height: 100px; border: 2px solid transparent;
            border-top: 2px solid var(--accent-blue); border-radius: 50%;
            animation: spin 1s linear infinite; position: relative;
        }
        .loader-ring::before {
            content: '\f7d6'; font-family: "Font Awesome 6 Free"; font-weight: 900;
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%); color: var(--accent-blue);
            font-size: 1.5rem; animation: pulse 1s infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes pulse { 0%, 100% { opacity: 0.5; transform: translate(-50%, -50%) scale(0.8); } 50% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); } }

        /* --- NAVEGACIÓN --- */
        .nav-header {
            position: fixed; top: 0; width: 100%; height: 80px;
            display: flex; align-items: center; padding: 0 25px;
            z-index: 1000; background: linear-gradient(to bottom, var(--bg-deep), transparent);
        }
        .back-circle {
            width: 48px; height: 48px; border-radius: 50%;
            background: var(--glass-white); border: 1px solid var(--glass-border);
            display: flex; align-items: center; justify-content: center;
            color: white; text-decoration: none; backdrop-filter: blur(15px);
            transition: all 0.4s cubic-bezier(0.2, 1, 0.3, 1);
        }

        /* --- CONTENIDO PRINCIPAL --- */
        .main-content {
            padding: 100px 20px 200px; /* Padding extra para el HUD móvil */
            max-width: 1300px; margin: 0 auto;
            position: relative; z-index: 10;
        }

        .step-indicator {
            text-align: center; margin-bottom: 40px;
            animation: fadeDown 1s ease-out;
        }
        .step-number {
            display: inline-block; padding: 6px 18px; border-radius: 50px;
            background: rgba(37, 99, 235, 0.1); color: var(--accent-blue);
            font-size: 0.65rem; font-weight: 800; letter-spacing: 2.5px;
            text-transform: uppercase; margin-bottom: 12px;
            border: 1px solid rgba(37, 99, 235, 0.2);
        }
        .step-title {
            font-family: var(--font-serif); font-size: clamp(2.2rem, 10vw, 4.5rem);
            font-weight: 400; color: #fff; letter-spacing: -1px;
        }

        /* --- LUXURY GRID --- */
        .luxury-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }
        @media (min-width: 768px) { .luxury-grid { grid-template-columns: repeat(3, 1fr); gap: 30px; } }
        @media (min-width: 1200px) { .luxury-grid { grid-template-columns: repeat(4, 1fr); gap: 40px; } }

        .luxury-card {
            position: relative; border-radius: 28px; overflow: hidden;
            background: linear-gradient(145deg, rgba(25, 12, 18, 0.6), rgba(10, 5, 8, 0.8));
            border: 1px solid var(--glass-border);
            transition: all 0.5s cubic-bezier(0.165, 0.84, 0.44, 1);
            cursor: pointer;
        }
        .luxury-card::before {
            content: ''; position: absolute; inset: 0;
            background: radial-gradient(circle at top right, rgba(37, 99, 235, 0.2), transparent);
            opacity: 0; transition: 0.5s;
        }
        .luxury-card:hover { transform: translateY(-8px); border-color: rgba(37, 99, 235, 0.4); }
        .luxury-card.selected { 
            border-color: var(--accent-blue); 
            box-shadow: 0 0 30px rgba(37, 99, 235, 0.2);
        }
        .luxury-card.selected::after {
            content: '\f00c'; font-family: "Font Awesome 6 Free"; font-weight: 900;
            position: absolute; top: 15px; right: 15px; width: 30px; height: 30px;
            background: var(--accent-blue); color: white; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; font-size: 0.75rem;
            z-index: 5; animation: popIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes popIn { from { transform: scale(0); } to { transform: scale(1); } }

        .img-container { width: 100%; aspect-ratio: 0.8/1; overflow: hidden; position: relative; background: #111; }
        .img-container img { width: 100%; height: 100%; object-fit: cover; transition: 1.2s ease; }
        .luxury-card:hover .img-container img { transform: scale(1.1); }

        .card-details { padding: 18px; text-align: left; }
        .card-name { font-family: var(--font-serif); font-size: 1.2rem; color: #fff; margin-bottom: 4px; }
        .card-price { font-family: var(--font-sans); color: var(--light-blue); font-weight: 700; font-size: 0.95rem; opacity: 0.9; }

        /* --- HUD (ESTADO) --- */
        .hud-wrapper {
            position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%) translateY(200%);
            width: 92%; max-width: 500px; z-index: 2000;
            transition: transform 0.8s cubic-bezier(0.2, 1, 0.3, 1);
        }
        .hud-wrapper.visible { transform: translateX(-50%) translateY(0); }
        .hud-content {
            background: rgba(15, 8, 10, 0.8); backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
            border: 1px solid rgba(255,255,255,0.1); border-radius: 100px;
            padding: 8px 8px 8px 30px; display: flex; align-items: center; justify-content: space-between;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.7);
        }
        .total-label { font-size: 0.55rem; text-transform: uppercase; letter-spacing: 2px; color: var(--light-blue); font-weight: 700; margin-bottom: 2px; }
        .total-value { font-family: var(--font-serif); font-size: 1.6rem; color: #fff; line-height: 1; }
        .btn-advance {
            background: linear-gradient(135deg, var(--accent-blue), var(--primary-blue));
            color: #fff; border: none; padding: 16px 32px; border-radius: 100px;
            font-weight: 800; font-size: 0.8rem; letter-spacing: 1px; cursor: pointer;
            text-transform: uppercase; display: flex; align-items: center; gap: 10px;
            box-shadow: 0 8px 20px rgba(37, 99, 235, 0.3);
            transition: 0.3s;
        }
        .btn-advance:active { transform: scale(0.95); }

        /* --- TUTORIAL SYSTEM --- */
        #tutorial-system {
            position: fixed; inset: 0; z-index: 9000;
            opacity: 0; visibility: hidden; transition: 0.5s; pointer-events: none;
        }
        #tutorial-system.active { opacity: 1; visibility: visible; pointer-events: auto; background: rgba(0,0,0,0.4); }
        .tutorial-spotlight {
            position: absolute; z-index: 9001;
            border-radius: 24px; box-shadow: 0 0 0 9999px rgba(0,0,0,0.8), 0 0 30px var(--accent-blue);
            transition: all 0.5s cubic-bezier(0.19, 1, 0.22, 1);
        }
        .tutorial-modal {
            position: fixed; z-index: 9002;
            width: 90%; max-width: 350px; left: 50%; top: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            background: rgba(15, 5, 8, 0.95);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(37, 99, 235, 0.3); border-radius: 30px;
            padding: 30px 25px; text-align: center; opacity: 0; transition: 0.5s;
            box-shadow: 0 20px 50px rgba(0,0,0,0.8);
        }
        
        @media (max-width: 600px) {
            .tutorial-modal { top: auto !important; bottom: 30px !important; transform: translate(-50%, 0) scale(0.9) !important; }
            .tutorial-modal.visible { transform: translate(-50%, 0) scale(1) !important; }
        }

        .tutorial-modal.visible { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        .t-step-tag { font-size: 0.6rem; color: var(--accent-blue); font-weight: 900; letter-spacing: 4px; text-transform: uppercase; margin-bottom: 15px; display: block; }
        .t-icon-container { width: 60px; height: 60px; margin: 0 auto 20px; background: rgba(37, 99, 235, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--accent-blue); font-size: 1.5rem; }
        .t-title { font-family: var(--font-serif); font-size: 1.8rem; color: #fff; margin-bottom: 10px; }
        .t-text { font-size: 0.9rem; color: rgba(248,250,252,0.6); line-height: 1.6; margin-bottom: 30px; }
        .t-next-btn { width: 100%; padding: 18px; border-radius: 18px; border: none; background: #fff; color: #000; font-weight: 800; text-transform: uppercase; cursor: pointer; }

        @keyframes fadeDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div id="luxury-loader">
        <div class="loader-ring"></div>
        <p style="margin-top: 25px; letter-spacing: 5px; font-size: 0.6rem; color: var(--soft-rose); font-weight: 700;">PREPARANDO SELECCIÓN</p>
    </div>

    <div id="tutorial-system">
        <div class="tutorial-spotlight" id="t-spotlight"></div>
        <div class="tutorial-modal" id="t-modal">
            <span class="t-step-tag" id="t-tag">Paso 1 / 2</span>
            <div class="t-icon-container"><i id="t-icon" class="fa-solid fa-gem"></i></div>
            <h2 class="t-title" id="t-title">Título</h2>
            <p class="t-text" id="t-desc">Descripción aquí.</p>
            <button class="t-next-btn" onclick="ProTour.next()">Entendido</button>
        </div>
    </div>

    <canvas id="particleCanvas"></canvas>
    <div class="ambient-light"></div>

    <nav class="nav-header">
        <a href="personalizar.html" class="back-circle"><i class="fa-solid fa-arrow-left"></i></a>
    </nav>

    <div class="main-content">
        <div class="step-indicator">
            <span class="step-number">Personalizaciòn Paso 02</span>
            <h1 class="step-title">Tamaño</h1>
        </div>

        <div class="luxury-grid" id="product-grid">
            </div>
    </div>

    <div class="hud-wrapper" id="main-hud">
        <div class="hud-content">
            <div class="total-box">
                <p class="total-label">Inversión Estimada</p>
                <h2 class="total-value" id="hud-total">L. 0</h2>
            </div>
            <button class="btn-advance" onclick="ProTour.validateAndNext()">
                Siguiente <i class="fa-solid fa-arrow-right"></i>
            </button>
        </div>
    </div>

    <script>
        const CONFIG = {
            CSV_URL: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSheerC3w1tm9SBphhiBbcBilUptScEZyxvxPJCFy3nY9nQ9ovj4xE2r0Sp3GirXuDmtPDs9GDpjkTz/pub?output=csv",
            STORAGE_BASE_CODE: 'alexa_code_step1',
            STORAGE_TOTAL: 'alexa_total',
            NEXT_PAGE: 'personalizar3.html'
        };

        let localState = { products: [], selection: null, basePrice: 0 };

        // Background Particles
        const pCanvas = document.getElementById('particleCanvas');
        const pCtx = pCanvas.getContext('2d');
        let particles = [];

        class Particle {
            constructor() { this.reset(); }
            reset() {
                this.x = Math.random() * pCanvas.width;
                this.y = Math.random() * pCanvas.height;
                this.size = Math.random() * 2 + 1;
                this.speedX = Math.random() * 0.5 - 0.25;
                this.speedY = Math.random() * 0.5 - 0.25;
                this.opacity = Math.random() * 0.5 + 0.1;
            }
            update() {
                this.x += this.speedX;
                this.y += this.speedY;
                if(this.x < 0 || this.x > pCanvas.width || this.y < 0 || this.y > pCanvas.height) this.reset();
            }
            draw() {
                pCtx.save();
                pCtx.globalAlpha = this.opacity;
                pCtx.fillStyle = '#60a5fa';
                pCtx.beginPath();
                pCtx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                pCtx.fill();
                pCtx.restore();
            }
        }

        function initParticles() {
            pCanvas.width = window.innerWidth;
            pCanvas.height = window.innerHeight;
            particles = Array.from({ length: 50 }, () => new Particle());
        }

        function drawParticles() {
            pCtx.clearRect(0, 0, pCanvas.width, pCanvas.height);
            particles.forEach(p => {
                p.update();
                p.draw();
            });
            requestAnimationFrame(drawParticles);
        }

        async function loadProductData() {
            const currentFilter = localStorage.getItem(CONFIG.STORAGE_BASE_CODE);
            localState.basePrice = parseFloat(localStorage.getItem(CONFIG.STORAGE_TOTAL)) || 0;

            if(!currentFilter) { window.location.href = "personalizar.html"; return; }

            try {
                const response = await fetch(CONFIG.CSV_URL);
                const text = await response.text();
                const rows = text.split(/\r?\n/).slice(1);

                localState.products = rows.map(row => {
                    const columns = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                    return {
                        id: columns[0]?.trim(),
                        stepCode: columns[1]?.trim(), 
                        category: columns[2]?.trim(),
                        name: columns[3]?.replace(/"/g,'').trim(),
                        price: parseFloat(columns[4]) || 0,
                        code: columns[5]?.trim(),
                        img: columns[6]?.trim()
                    };
                }).filter(p => p.stepCode === currentFilter && p.category === 'Tamaño');

                renderLuxuryGrid();
                updateHud(localState.basePrice);
            } catch (err) {
                console.error("Error CSV:", err);
            } finally {
                setTimeout(() => {
                    document.getElementById('luxury-loader').style.opacity = '0';
                    setTimeout(() => {
                        document.getElementById('luxury-loader').style.display = 'none';
                        ProTour.init();
                    }, 600);
                }, 800);
            }
        }

        function renderLuxuryGrid() {
            const grid = document.getElementById('product-grid');
            grid.innerHTML = localState.products.map((p, i) => `
                <div class="luxury-card" id="card-${i}" onclick="handleSelection('${p.id}', ${i})">
                    <div class="img-container">
                        <img src="${p.img}" alt="${p.name}" loading="lazy" onerror="this.src='https://via.placeholder.com/400x500?text=ALEXA'">
                    </div>
                    <div class="card-details">
                        <h3 class="card-name">${p.name}</h3>
                        <p class="card-price">+ L. ${p.price.toLocaleString()}</p>
                    </div>
                </div>
            `).join('');
        }

        function handleSelection(id, index) {
            const product = localState.products.find(p => p.id === id);
            localState.selection = product;
            document.querySelectorAll('.luxury-card').forEach(c => c.classList.remove('selected'));
            document.getElementById(`card-${index}`).classList.add('selected');
            updateHud(localState.basePrice + product.price);

            if(ProTour.isActive && ProTour.currentStep === 0) {
                setTimeout(() => ProTour.next(), 400);
            }
        }

        function updateHud(value) {
            document.getElementById('hud-total').innerText = `L. ${value.toLocaleString()}`;
            document.getElementById('main-hud').classList.add('visible');
        }

        const ProTour = {
            isActive: false,
            currentStep: 0,
            steps: [
                { target: '#card-0', title: 'Selecciona el Tamaño', desc: 'El tamaño define el impacto. Elige la opción ideal.', icon: 'fa-maximize' },
                { target: '#main-hud', title: 'Tu Inversión', desc: 'Controla el total de tu personalización en tiempo real.', icon: 'fa-calculator' }
            ],
            init() {
                if(localStorage.getItem('alexa_tour_p2_v6')) return;
                this.isActive = true;
                document.getElementById('tutorial-system').classList.add('active');
                this.render();
            },
            render() {
                const step = this.steps[this.currentStep];
                const targetEl = document.querySelector(step.target);
                const spotlight = document.getElementById('t-spotlight');
                const modal = document.getElementById('t-modal');
                modal.classList.remove('visible');
                if(targetEl) {
                    const rect = targetEl.getBoundingClientRect();
                    spotlight.style.top = `${rect.top - 8}px`;
                    spotlight.style.left = `${rect.left - 8}px`;
                    spotlight.style.width = `${rect.width + 16}px`;
                    spotlight.style.height = `${rect.height + 16}px`;
                }
                setTimeout(() => {
                    document.getElementById('t-tag').innerText = `Paso ${this.currentStep + 1} / ${this.steps.length}`;
                    document.getElementById('t-title').innerText = step.title;
                    document.getElementById('t-desc').innerText = step.desc;
                    document.getElementById('t-icon').className = `fa-solid ${step.icon}`;
                    modal.classList.add('visible');
                }, 300);
            },
            next() {
                this.currentStep++;
                if(this.currentStep < this.steps.length) this.render();
                else this.finish();
            },
            finish() {
                this.isActive = false;
                document.getElementById('tutorial-system').classList.remove('active');
                localStorage.setItem('alexa_tour_p2_v6', 'true');
            },
            validateAndNext() {
                if(!localState.selection) { alert("Selecciona un tamaño para continuar."); return; }
                
                localStorage.setItem('alexa_code_step2', localState.selection.code);
                localStorage.setItem('alexa_final_box', localState.selection.name);
                
                const nuevoTotal = localState.basePrice + localState.selection.price;
                localStorage.setItem('alexa_total', nuevoTotal);
                localStorage.setItem('alexa_subtotal_base', nuevoTotal);

                document.body.style.opacity = '0';
                setTimeout(() => window.location.href = CONFIG.NEXT_PAGE, 500);
            }
        };

        window.addEventListener('resize', initParticles);
        document.addEventListener('DOMContentLoaded', () => { initParticles(); drawParticles(); loadProductData(); });
    </script>
</body>
</html>